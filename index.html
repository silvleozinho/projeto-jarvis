<script type="module">
    import { GoogleGenerativeAI } from "@google/generative-ai";

    // 1. INSIRA SUA CHAVE AQUI (...ct8Y)
    const API_KEY = "AIzaSyAgQd73RpCDiiryWChwhZPKgcl7Mj6ct8Y"; 
    const genAI = new GoogleGenerativeAI(API_KEY);
    
    // MUDANÇA VITAL: Usando a versão 'latest' que resolve o erro 404
    const model = genAI.getGenerativeModel({ model: "gemini-1.5-flash-latest" });

    const chat = document.getElementById('chat');
    const campo = document.getElementById('campo-texto');

    window.falar = (texto) => {
        window.speechSynthesis.cancel();
        const msg = new SpeechSynthesisUtterance(texto);
        msg.lang = 'pt-BR';
        window.speechSynthesis.speak(msg);
    };

    window.enviarTexto = async () => {
        const texto = campo.value;
        if(!texto) return;
        
        chat.innerHTML += `<div class="msg user">${texto}</div>`;
        campo.value = "";
        
        try {
            // Chamada direta ao núcleo atualizado
            const result = await model.generateContent(texto);
            const response = await result.response;
            const respostaTexto = response.text(); 
            
            chat.innerHTML += `<div class="msg jarvis"><b>JARVIS:</b> ${respostaTexto}</div>`;
            window.falar(respostaTexto);
        } catch (e) {
            // Se o erro persistir, ele vai detalhar aqui
            console.error(e);
            chat.innerHTML += `<div class="msg jarvis" style="color:red">FALHA NO PROTOCOLO: ${e.message}</div>`;
        }
        chat.scrollTop = chat.scrollHeight;
    };

    const recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
    recognition.lang = 'pt-BR';
    recognition.onresult = (event) => {
        campo.value = event.results[0][0].transcript;
        enviarTexto();
    };

    window.iniciar = () => {
        document.getElementById('overlay').style.display = 'none';
        window.falar("Sistemas reiniciados. Rota 404 corrigida. Pronto, senhor.");
        try { recognition.start(); } catch(e){}
    };

    recognition.onend = () => { if(document.getElementById('overlay').style.display === 'none') recognition.start(); };
</script>